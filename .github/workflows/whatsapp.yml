name: CADIIA WhatsApp Agent

on:
  workflow_dispatch:
  push:
    paths:
      - "processar.py"
      - "relay.js"
      - ".github/workflows/whatsapp.yml"
  schedule:
    - cron: "*/10 * * * *"

# ðŸ”“ Nunca mais fica preso esperando outro job
concurrency:
  group: cadiia-whatsapp
  cancel-in-progress: true

jobs:
  agente:
    runs-on: ubuntu-latest
    timeout-minutes: 355

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ZAPI_INSTANCE:  ${{ secrets.ZAPI_INSTANCE }}
      ZAPI_TOKEN:     ${{ secrets.ZAPI_TOKEN }}
      MASTER_PHONE:   ${{ secrets.MASTER_PHONE }}

    steps:
      - uses: actions/checkout@v4

      - name: Preparar SO (com retry)
        run: |
          for i in 1 2 3; do
            sudo apt-get update && sudo apt-get install -y python3-pip && break || sleep 5
          done

      - name: Instalar deps Python/Node (com retry)
        run: |
          python3 --version
          python3 -m pip install --upgrade pip
          for i in 1 2 3; do pip install openai requests httpx anyio || sleep 5; done
          for i in 1 2 3; do npm install node-fetch || sleep 5; done

      - name: Iniciar Relay (nohup + log)
        run: |
          echo "ðŸŸ¢ Relay CADIIA iniciado..."
          nohup node relay.js > relay.log 2>&1 &

      - name: Iniciar CADIIA (nohup + log)
        run: |
          echo "ðŸ¤– CADIIA iniciando processamento contÃ­nuo..."
          nohup python3 processar.py > cadIIa.log 2>&1 &

      - name: Segurar runner vivo (tail contÃ­nuo)
        run: |
          echo "ðŸ“œ Logs em tempo real (Ctrl+C encerra):"
          tail -F relay.log cadIIa.log
